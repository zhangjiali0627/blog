---
layout: post
categories: js
title: "跨域"
subtitle: "前端开发的过程中，经常会遇到跨域问题，本文将对跨域做一个简单的总结。"
featured-image: /images/2016-11-19/abstract-2.jpg
tags: ['JS']
date-string: Jul 26, 2020
---

## 什么是跨域

跨域，是指浏览器不能执行其他网站的脚本。跨域是由浏览器的通源策略造成的，是浏览器对Javascript实施的安全限制。

同源策略限制了以下行为：
- Cookie、LocalStorage和IndexDB无法读取
- DOM和JS对象无法获取
- Ajax请求发送不出去

## 常见的跨域场景

所谓的同源是指域名、协议、端口均相同。

```js
  http://www.baidu.com/a.html 调用 http://www.baidu.com/server.php 非跨域

  http://www.baidu.com/a.html 调用 http://www.baidu1.com/server.php 跨域，主域不同
  
  http://abc.baidu.com/a.html 调用 http://def.baidu1.com/server.php 跨域，子域名不同

  http://www.baidu.com:8000/a.html 调用 http://www.baidu.com/server.php 跨域，端口不同

  https://www.baidu.com/a.html 调用 http://www.baidu.com/server.php 跨域，协议不同

  localhost 调用 127.0.0.1 跨域
```

## 跨域的解决办法

### jsonp 跨域

jsonp 跨域其实也是Javascript设计模式中的一种代理模式。在html页面中通过相应的标签从不同域名下加载静态资源文件是被浏览器允许的，所以我们可以通过这个“漏洞”来进行跨域。一般，我们可以动态的创建script标签，再去请求一个带参网址来实现跨域通信。

```js
  // 原生的实现方式
  let script = document.createElement('script');
  script.src = 'http://www.baidu.com/login?username=Zhangsan&callback=callback';

  document.body.appendChild(script);

  let callback = (res) => {
    console.log(res);
  }
```

当然，jquery也支持jsonp的实现方式

```js
  $.ajax({
    url:'http://www.baidu.com/login',
    type:'GET',
    dataType:'jsonp',//请求方式为jsonp
    jsonpCallback:'callback',
    data:{
        "username":"Zhangsan"
    },
  })
```
#### 虽然这种方式非常好用，兼容性也非常好，但是一个最大的缺陷是，只能够实现get请求。

### postMessage 跨域

这是由H5提出来的一个API，IE8+，chrome，FF都支持实现这个功能。这个功能非常的简单，其中包括接受信息的message时间，和发送信息的postMessage方法。

发送信息的postMessage方法是向外界窗口发送信息
```
  otheWindow.postMessage(message,targetOrigin);
```
- otherWindow 指的是目标窗口，也就是要给哪一个window发送消息，是window.frames属性的成员或者是window.open方法创建的窗口。
- message是要发送的消息，类型为String，Object（IE8、9不支持Obj），targetOrigin是限定消息接受范围，不限制就用星号*

接受信息的message事件

```js
  let onmessage = () => {
    let data = event.data;
    let origin =event.origin;
  }
  if(typeof window.addEventListener != 'undefined') {
    window.addEventListener('message', onmessage, false);
  }else if(typeof window.attachEvent != 'undefiner') {
    window.attachEvent('onmessage', onmessage);
  }
```

eg:
a.html(www.baidu.com/a/html)

```html
  <iframe id="iframe" src="http://www.bai.com/b.html" style="display:none;"></iframe>
  <script>       
      var iframe = document.getElementById('iframe');
      iframe.onload = function() {
          var data = {
              name: 'aym'
          };
          // 向bai传送跨域数据
          iframe.contentWindow.postMessage(JSON.stringify(data), 'http://www.bai.com');
      };

      // 接受domain2返回数据
      window.addEventListener('message', function(e) {
          alert('data from bai ---> ' + e.data);
      }, false);
  </script>
```

b.html(www.bai.com/b.html)

```html
  <script>
      // 接收domain1的数据
      window.addEventListener('message', function(e) {
          alert('data from baidu ---> ' + e.data);

          var data = JSON.parse(e.data);
          if (data) {
              data.number = 16;

              // 处理后再发回baidu
              window.parent.postMessage(JSON.stringify(data), 'http://www.baidu.com');
          }
      }, false);
  </script>
```


### document.domain + iframe 跨域

这种跨域的方式最主要的是要求主域名相同。

#### 什么是主域名相同？
www.baidu.com

aaa.baidu.com

ba.ad.baidu.com

以上这三个主域名都是baidu.com,而主域名不同的就不能用此方法。

假设目前a.baidu.com和b.baidu.com分别对应指向不同ip的服务器。

a.baidu.com下有一个test.html文件

```html
  <!DOCTYPE html>
  <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>html</title>
        <script type="text/javascript" src = "jquery-1.12.1.js"></script>
    </head>
    <body>
        <div>A页面</div>
        <iframe 
        style = "display : none" 
        name = "iframe1" 
        id = "iframe" 
        src="http://b.baidu.com/1.html" frameborder="0"></iframe>
        <script type="text/javascript">
            $(function(){
                try{
                    document.domain = "baidu.com"
                }catch(e){}
                $("#iframe").load(function(){
                    var jq = document.getElementById('iframe').contentWindow.$
                    jq.get("http://baidu.com/test.json",function(data){
                        console.log(data);
                    });
                })
            })
        </script>
    </body>
  </html>
```

利用iframe加载了其他域下的文件（baidu.com/1.html），同时document.domain 设置成了 baidu.com，当iframe加载完毕后就可以获取baidu.com域下的全局对象，此时尝试着去请求baidu.com域名下的test.json(请求接口），就会发现数据请求失败了。

数据请求失败，是因为还缺少一步：

```html
  <!DOCTYPE html>
  <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>html</title>
        <script type="text/javascript" src = "jquery-1.12.1.js"></script>
        <script type="text/javascript">
            $(function(){
                try{
                    document.domain = "baidu.com"
                }catch(e){}
            })
        </script>
    </head>
    <body>
        <div id = "div1">B页面</div>
    </body>
  </html>
```
此时刷新浏览器，就会发现数据请求成功了~~~~~